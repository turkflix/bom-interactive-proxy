# BOM Interactive Proxy - Perfect Browser Simulation

# Rate limiting to mimic human browsing patterns  
limit_req_zone $binary_remote_addr zone=browser:10m rate=20r/s;
limit_req_zone $binary_remote_addr zone=api:10m rate=100r/s;
limit_req_zone $binary_remote_addr zone=assets:10m rate=200r/s;

# Upstream BOM servers
upstream bom_www {
    server www.bom.gov.au:443;
    keepalive 32;
}

upstream bom_api {
    server api.bom.gov.au:443;
    keepalive 32;
}

server {
    listen 80;
    server_name _;
    
    # DNS resolver 
    resolver 8.8.8.8 1.1.1.1 valid=300s;
    resolver_timeout 5s;
    
    # Browser-like connection settings
    keepalive_timeout 65;
    keepalive_requests 1000;

    # Drop non-essential SVG chrome assets not required by map rendering.
    location ~* ^/(themes/custom/bom_theme/images|themes/custom/bom_theme/bom-react/dist/assets|modules/custom/bom_utilities/images)/.+\.svg$ {
        access_log off;
        add_header Access-Control-Allow-Origin * always;
        add_header Cache-Control "public, max-age=3600" always;
        return 204;
    }
    
    # Add realistic delays to mimic browser loading
    # Image/font assets served from BOM web; JS/CSS are handled by dedicated rules below.
    # Excludes API/mapping paths that also end in image extensions.
    location ~ ^/(?!apikey/|api/|v1/|mapping/|timeseries/|overlays/|basemaps/).+\.(png|jpg|jpeg|gif|ico|svg|webp)$ {
        access_log off;
        add_header Cache-Control "public, max-age=31536000, immutable";
        try_files $uri @proxy_static;
    }

    # Health check endpoint
    location = /health {
        access_log off;
        add_header Content-Type text/plain always;
        add_header Access-Control-Allow-Origin * always;
        return 200 "OK\n";
    }

    # Debug endpoint to test API routing
    location = /debug {
        add_header Content-Type text/plain always;
        add_header Access-Control-Allow-Origin * always;
        return 200 "Debug: API routing working\n";
    }

    # Enhanced logging endpoint for detailed diagnostics
    location = /log-request {
        add_header Content-Type application/json always;
        add_header Access-Control-Allow-Origin * always;
        return 200 '{"status":"logged","timestamp":"$time_iso8601","args":"$args","user_agent":"$http_user_agent"}';
    }

    # Sink endpoint for stripped/non-essential third-party calls.
    location = /blocked-external/interaction.json {
        add_header Content-Type "application/json" always;
        add_header Access-Control-Allow-Origin * always;
        add_header Cache-Control "no-store" always;
        return 200 '{"blocked":true,"place":null,"places":[],"candidates":[],"results":[],"observations":[],"data":[],"series":[]}';
    }

    location ^~ /blocked-external/ {
        add_header Access-Control-Allow-Origin * always;
        add_header Cache-Control "public, max-age=3600" always;
        return 204;
    }

    # Drop Akamai anti-bot/telemetry loader artifacts after host rewrites.
    # These are not required for radar map rendering in map-only mode.
    location ^~ /akam/ {
        add_header Access-Control-Allow-Origin * always;
        add_header Cache-Control "public, max-age=3600" always;
        return 204;
    }

    # Default experience: full-screen map-only view
    location = / {
        root /usr/share/nginx/html;
        try_files /map-only.html =404;
        add_header Content-Type text/html always;
        add_header Access-Control-Allow-Origin * always;
        add_header X-Frame-Options ALLOWALL always;
    }

    location = /index.html {
        root /usr/share/nginx/html;
        try_files /map-only.html =404;
        add_header Content-Type text/html always;
        add_header Access-Control-Allow-Origin * always;
        add_header X-Frame-Options ALLOWALL always;
    }

    # Custom map page
    location = /map {
        alias /usr/share/nginx/html/;
        index map.html;
        try_files /map.html =404;
        add_header Access-Control-Allow-Origin * always;
        add_header X-Frame-Options ALLOWALL always;
    }

    # Minimal full-screen map page (no harness chrome)
    location = /map-only {
        root /usr/share/nginx/html;
        try_files /map-only.html =404;
        add_header Content-Type text/html always;
        add_header Access-Control-Allow-Origin * always;
        add_header X-Frame-Options ALLOWALL always;
    }

    location = /map-only.html {
        root /usr/share/nginx/html;
        add_header Content-Type text/html always;
        add_header Access-Control-Allow-Origin * always;
        add_header X-Frame-Options ALLOWALL always;
    }

    # Browser test harness (automated smoke checks + map embed)
    location = /test-harness {
        root /usr/share/nginx/html;
        try_files /test-harness.html =404;
        add_header Content-Type text/html always;
        add_header Access-Control-Allow-Origin * always;
        add_header X-Frame-Options ALLOWALL always;
    }

    location = /test-harness.html {
        root /usr/share/nginx/html;
        add_header Content-Type text/html always;
        add_header Access-Control-Allow-Origin * always;
        add_header X-Frame-Options ALLOWALL always;
    }

    # Debug harness for comprehensive testing
    location = /debug-harness {
        root /usr/share/nginx/html;
        try_files /debug-harness.html =404;
        add_header Content-Type text/html always;
        add_header Access-Control-Allow-Origin * always;
        add_header X-Frame-Options ALLOWALL always;
    }
    
    # Alternative debug path
    location = /debug-harness.html {
        root /usr/share/nginx/html;
        add_header Content-Type text/html always;
        add_header Access-Control-Allow-Origin * always;
        add_header X-Frame-Options ALLOWALL always;
    }

    # API override JavaScript
    location = /inject-api-override.js {
        alias /usr/share/nginx/html/inject-api-override.js;
        add_header Content-Type "application/javascript" always;
        add_header Access-Control-Allow-Origin * always;
        expires 1h;
    }

    # Lean-mode defaults: disable third-party tag manager scripts not needed for map rendering.
    location = /modules/contrib/google_tag/js/gtag.js {
        add_header Content-Type "application/javascript" always;
        add_header Access-Control-Allow-Origin * always;
        add_header Cache-Control "public, max-age=3600" always;
        return 200 "window.dataLayer=window.dataLayer||[];function gtag(){window.dataLayer.push(arguments);}";
    }

    location = /modules/contrib/google_tag/js/gtm.js {
        add_header Content-Type "application/javascript" always;
        add_header Access-Control-Allow-Origin * always;
        add_header Cache-Control "public, max-age=3600" always;
        return 200 "window.dataLayer=window.dataLayer||[];";
    }

    # Browser tile-cache service worker script.
    # Keep this non-cached so updates are picked up quickly.
    location = /map-sw.js {
        root /usr/share/nginx/html;
        try_files /map-sw.js =404;
        add_header Content-Type "application/javascript" always;
        add_header Access-Control-Allow-Origin * always;
        add_header Cache-Control "no-cache" always;
    }

    location ^~ /themes/custom/bom_theme/bom-react/dist/assets/@ausbom/weather-icons/ {
        add_header Access-Control-Allow-Origin * always;
        add_header Cache-Control "public, max-age=3600" always;
        return 204;
    }

    location = /themes/custom/bom_theme/bom-react/dist/assets/bundled/white-chevron.svg {
        add_header Access-Control-Allow-Origin * always;
        add_header Cache-Control "public, max-age=3600" always;
        return 204;
    }

    location = /themes/custom/bom_theme/images/footer_logo.svg {
        add_header Access-Control-Allow-Origin * always;
        add_header Cache-Control "public, max-age=3600" always;
        return 204;
    }

    location @towns_overlay_passthrough {
        proxy_set_header Host api.bom.gov.au;
        proxy_set_header User-Agent "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36";
        proxy_set_header Accept "*/*";
        proxy_set_header Accept-Language "en-AU,en-GB;q=0.9,en-US;q=0.8,en;q=0.7";
        proxy_set_header Accept-Encoding "";
        proxy_set_header Sec-Fetch-Dest "empty";
        proxy_set_header Sec-Fetch-Mode "cors";
        proxy_set_header Sec-Fetch-Site "cross-site";
        proxy_set_header Origin "https://www.bom.gov.au";
        proxy_set_header Referer "https://www.bom.gov.au/location/australia/victoria/central/o2594692629-ashburton";
        proxy_set_header X-Real-IP "";
        proxy_set_header X-Forwarded-For "";
        proxy_set_header X-Forwarded-Proto "";
        proxy_pass https://bom_api/apikey/v1/mapping$request_uri;
        proxy_ssl_server_name on;
        proxy_ssl_verify off;
        proxy_http_version 1.1;
        proxy_connect_timeout 30s;
        proxy_send_timeout 30s;
        proxy_read_timeout 60s;
        proxy_cache bom_tiles;
        proxy_cache_methods GET HEAD;
        proxy_cache_lock on;
        proxy_cache_background_update on;
        proxy_cache_revalidate on;
        proxy_ignore_headers Cache-Control Expires Set-Cookie;
        proxy_hide_header Set-Cookie;
        proxy_hide_header Cache-Control;
        proxy_hide_header Expires;
        proxy_cache_valid 200 301 302 120s;
        proxy_cache_valid 404 30s;
        proxy_cache_valid 403 10s;
        proxy_hide_header Access-Control-Allow-Origin;
        add_header Access-Control-Allow-Origin * always;
        add_header Access-Control-Allow-Methods "GET, POST, OPTIONS" always;
        add_header Access-Control-Allow-Headers "Origin, X-Requested-With, Content-Type, Accept, Authorization" always;
        add_header Vary "Cookie" always;
        add_header Cache-Control "public, max-age=60";
        add_header X-Proxy-Cache $upstream_cache_status always;
    }

    # Remove place-name overlays by default by serving an empty towns/cities FeatureServer.
    # If cookie `bom_show_town_names=1` is present, bypass stubs and proxy the real overlay.
    location = /overlays/towns_and_cities/FeatureServer {
        error_page 418 = @towns_overlay_passthrough;
        if ($cookie_bom_show_town_names = "1") { return 418; }
        if ($http_referer ~* "(?:[?&](?:showTownNames|townNames|townnames|townLabels|townlabels|towns)=(?:1|true|on|yes))(?:[&#]|$)") { return 418; }
        add_header Content-Type application/json always;
        add_header Access-Control-Allow-Origin * always;
        add_header Vary "Cookie" always;
        add_header Cache-Control "no-store" always;
        return 200 '{"currentVersion":11.3,"serviceDescription":"","supportedQueryFormats":"JSON","maxRecordCount":2000,"capabilities":"Query","layers":[{"id":3,"name":"TOWNS","parentLayerId":-1,"defaultVisibility":false,"subLayerIds":null,"minScale":0,"maxScale":0,"type":"Feature Layer","geometryType":"esriGeometryPoint"}],"tables":[]}';
    }

    location = /overlays/towns_and_cities/FeatureServer/ {
        error_page 418 = @towns_overlay_passthrough;
        if ($cookie_bom_show_town_names = "1") { return 418; }
        if ($http_referer ~* "(?:[?&](?:showTownNames|townNames|townnames|townLabels|townlabels|towns)=(?:1|true|on|yes))(?:[&#]|$)") { return 418; }
        add_header Content-Type application/json always;
        add_header Access-Control-Allow-Origin * always;
        add_header Vary "Cookie" always;
        add_header Cache-Control "no-store" always;
        return 200 '{"currentVersion":11.3,"serviceDescription":"","supportedQueryFormats":"JSON","maxRecordCount":2000,"capabilities":"Query","layers":[{"id":3,"name":"TOWNS","parentLayerId":-1,"defaultVisibility":false,"subLayerIds":null,"minScale":0,"maxScale":0,"type":"Feature Layer","geometryType":"esriGeometryPoint"}],"tables":[]}';
    }

    location = /overlays/towns_and_cities/FeatureServer/3 {
        error_page 418 = @towns_overlay_passthrough;
        if ($cookie_bom_show_town_names = "1") { return 418; }
        if ($http_referer ~* "(?:[?&](?:showTownNames|townNames|townnames|townLabels|townlabels|towns)=(?:1|true|on|yes))(?:[&#]|$)") { return 418; }
        add_header Content-Type application/json always;
        add_header Access-Control-Allow-Origin * always;
        add_header Vary "Cookie" always;
        add_header Cache-Control "no-store" always;
        return 200 '{"currentVersion":11.3,"id":3,"name":"TOWNS","type":"Feature Layer","description":"suppressed in map-only mode","geometryType":"esriGeometryPoint","objectIdField":"OBJECTID","globalIdField":"","displayField":"NAME","fields":[{"name":"OBJECTID","type":"esriFieldTypeOID","alias":"OBJECTID"},{"name":"NAME","type":"esriFieldTypeString","alias":"NAME","length":256},{"name":"MIN_ZOOM_LVL","type":"esriFieldTypeSmallInteger","alias":"MIN_ZOOM_LVL"}],"drawingInfo":{"renderer":{"type":"simple","symbol":{"type":"esriSMS","style":"esriSMSCircle","size":1,"color":[0,0,0,0],"outline":{"color":[0,0,0,0],"width":0}}}},"capabilities":"Query","maxRecordCount":2000,"supportsStatistics":false,"supportsAdvancedQueries":true}';
    }

    location = /overlays/towns_and_cities/FeatureServer/3/query {
        error_page 418 = @towns_overlay_passthrough;
        if ($cookie_bom_show_town_names = "1") { return 418; }
        if ($http_referer ~* "(?:[?&](?:showTownNames|townNames|townnames|townLabels|townlabels|towns)=(?:1|true|on|yes))(?:[&#]|$)") { return 418; }
        add_header Content-Type application/json always;
        add_header Access-Control-Allow-Origin * always;
        add_header Vary "Cookie" always;
        add_header Cache-Control "no-store" always;
        return 200 '{"objectIdFieldName":"OBJECTID","globalIdFieldName":"","geometryType":"esriGeometryPoint","spatialReference":{"wkid":102100,"latestWkid":3857},"fields":[{"name":"OBJECTID","type":"esriFieldTypeOID","alias":"OBJECTID"},{"name":"NAME","type":"esriFieldTypeString","alias":"NAME","length":256},{"name":"MIN_ZOOM_LVL","type":"esriFieldTypeSmallInteger","alias":"MIN_ZOOM_LVL"}],"features":[]}';
    }

    # Cache-heavy BOM radar tile paths requested via /apikey/v1/mapping/*
    location ~ ^/apikey/v1/mapping/(timeseries|overlays|basemaps)/ {
        # Tile requests arrive in short bursts; allow queueing instead of 503 drops.
        limit_req zone=api burst=300;

        proxy_set_header Host api.bom.gov.au;
        proxy_set_header User-Agent "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36";
        proxy_set_header Accept "*/*";
        proxy_set_header Accept-Language "en-AU,en-GB;q=0.9,en-US;q=0.8,en;q=0.7";
        proxy_set_header Accept-Encoding "";
        proxy_set_header Sec-Fetch-Dest "empty";
        proxy_set_header Sec-Fetch-Mode "cors";
        proxy_set_header Sec-Fetch-Site "cross-site";
        proxy_set_header Origin "https://www.bom.gov.au";
        proxy_set_header Referer "https://www.bom.gov.au/location/australia/victoria/central/o2594692629-ashburton";

        proxy_set_header X-Real-IP "";
        proxy_set_header X-Forwarded-For "";
        proxy_set_header X-Forwarded-Proto "";

        proxy_pass https://bom_api$request_uri;
        proxy_ssl_server_name on;
        proxy_ssl_verify off;
        proxy_http_version 1.1;

        proxy_connect_timeout 30s;
        proxy_send_timeout 30s;
        proxy_read_timeout 60s;

        proxy_cache bom_tiles;
        proxy_cache_methods GET HEAD;
        proxy_cache_lock on;
        proxy_cache_background_update on;
        proxy_cache_revalidate on;
        proxy_ignore_headers Cache-Control Expires Set-Cookie;
        proxy_hide_header Set-Cookie;
        proxy_hide_header Cache-Control;
        proxy_hide_header Expires;
        proxy_cache_valid 200 301 302 60s;
        proxy_cache_valid 404 30s;

        # Preserve API host rewrites so browser never calls api.bom.gov.au directly.
        sub_filter_once off;
        sub_filter_types application/json application/xml text/xml text/plain;
        sub_filter 'https://api.bom.gov.au' 'http://$http_host';
        sub_filter 'https:\/\/api.bom.gov.au' 'http:\/\/$http_host';
        sub_filter 'https://www.bom.gov.au' 'http://$http_host';
        sub_filter 'https:\/\/www.bom.gov.au' 'http:\/\/$http_host';

        proxy_hide_header Access-Control-Allow-Origin;
        add_header Access-Control-Allow-Origin * always;
        add_header Access-Control-Allow-Methods "GET, POST, OPTIONS" always;
        add_header Access-Control-Allow-Headers "Origin, X-Requested-With, Content-Type, Accept, Authorization" always;
        add_header Cache-Control "public, max-age=60";
        add_header X-Proxy-Cache $upstream_cache_status always;
    }

    # Map-only mode does not require alert/news/webform widgets.
    # Serve deterministic local responses to avoid intermittent upstream bot blocks.
    location = /api/v1/curated-alerts {
        add_header Content-Type "application/json" always;
        add_header Access-Control-Allow-Origin * always;
        add_header Cache-Control "public, max-age=60" always;
        return 200 '{"anyLocationBasedAlert":false}';
    }

    location = /api/v1/global-alerts {
        add_header Content-Type "application/json" always;
        add_header Access-Control-Allow-Origin * always;
        add_header Cache-Control "public, max-age=60" always;
        return 200 '{"data":[]}';
    }

    location = /api/v1/nearby-news {
        add_header Content-Type "application/json" always;
        add_header Access-Control-Allow-Origin * always;
        add_header Cache-Control "public, max-age=60" always;
        return 200 '[]';
    }

    location ^~ /api/v1/webform/webform/ {
        add_header Content-Type "application/vnd.api+json" always;
        add_header Access-Control-Allow-Origin * always;
        add_header Cache-Control "public, max-age=300" always;
        return 200 '{"jsonapi":{"version":"1.0"},"data":{"type":"webform--webform","id":"proxy-map-only","attributes":{"langcode":"en","status":"closed"}}}';
    }

    # BOM content APIs (alerts/news/webform) are served from www, not api.bom.gov.au.
    # Use ^~ so this wins over the generic regex /api* gateway rule below.
    location ^~ /api/v1/ {
        limit_req zone=api burst=20 nodelay;

        proxy_set_header Host www.bom.gov.au;
        proxy_set_header User-Agent "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36";
        proxy_set_header Accept "application/json, text/plain, */*";
        proxy_set_header Accept-Language "en-AU,en-GB;q=0.9,en-US;q=0.8,en;q=0.7";
        # Disable upstream compression so sub_filter can rewrite payload URLs.
        proxy_set_header Accept-Encoding "";
        proxy_set_header Sec-Fetch-Dest "empty";
        proxy_set_header Sec-Fetch-Mode "cors";
        proxy_set_header Sec-Fetch-Site "same-origin";
        proxy_set_header Origin "https://www.bom.gov.au";
        proxy_set_header Referer "https://www.bom.gov.au/location/australia/victoria/central/o2594692629-ashburton";

        proxy_set_header X-Real-IP "";
        proxy_set_header X-Forwarded-For "";
        proxy_set_header X-Forwarded-Proto "";

        proxy_pass https://bom_www$request_uri;
        proxy_ssl_server_name on;
        proxy_ssl_verify off;
        proxy_http_version 1.1;

        proxy_connect_timeout 30s;
        proxy_send_timeout 30s;
        proxy_read_timeout 30s;

        # Keep embedded host references local.
        sub_filter_once off;
        sub_filter_types application/json application/vnd.api+json application/xml text/xml text/plain;
        sub_filter 'https://www.bom.gov.au' 'http://$http_host';
        sub_filter 'https:\/\/www.bom.gov.au' 'http:\/\/$http_host';
        sub_filter 'https://api.bom.gov.au' 'http://$http_host';
        sub_filter 'https:\/\/api.bom.gov.au' 'http:\/\/$http_host';

        proxy_hide_header Access-Control-Allow-Origin;
        add_header Access-Control-Allow-Origin * always;
        add_header Access-Control-Allow-Methods "GET, POST, OPTIONS" always;
        add_header Access-Control-Allow-Headers "Origin, X-Requested-With, Content-Type, Accept, Authorization" always;
    }

    # Prevent map click-driven full-page navigations into raw places API JSON.
    # Keep XHR/fetch access to these endpoints working.
    location ^~ /apikey/v1/locations/places/ {
        set $places_nav_return $http_referer;
        if ($places_nav_return = "") {
            set $places_nav_return /map;
        }
        if ($http_sec_fetch_mode = "navigate") {
            return 302 $places_nav_return;
        }
        if ($http_accept ~* "text/html") {
            return 302 $places_nav_return;
        }

        limit_req zone=api burst=30 nodelay;

        proxy_set_header Host api.bom.gov.au;
        proxy_set_header User-Agent "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36";
        proxy_set_header Accept "application/json, text/plain, */*";
        proxy_set_header Accept-Language "en-AU,en-GB;q=0.9,en-US;q=0.8,en;q=0.7";
        proxy_set_header Accept-Encoding "";
        proxy_set_header Content-Type "application/json";
        proxy_set_header Sec-Ch-Ua '"Not_A Brand";v="8", "Chromium";v="120", "Google Chrome";v="120"';
        proxy_set_header Sec-Ch-Ua-Mobile "?0";
        proxy_set_header Sec-Ch-Ua-Platform '"Windows"';
        proxy_set_header Sec-Fetch-Dest "empty";
        proxy_set_header Sec-Fetch-Mode "cors";
        proxy_set_header Sec-Fetch-Site "cross-site";
        proxy_set_header Origin "https://www.bom.gov.au";
        proxy_set_header Referer "https://www.bom.gov.au/location/australia/victoria/central/o2594692629-ashburton";

        proxy_set_header X-Real-IP "";
        proxy_set_header X-Forwarded-For "";
        proxy_set_header X-Forwarded-Proto "";

        proxy_pass https://bom_api$request_uri;
        proxy_ssl_server_name on;
        proxy_ssl_verify off;
        proxy_http_version 1.1;

        proxy_connect_timeout 30s;
        proxy_send_timeout 30s;
        proxy_read_timeout 30s;

        proxy_hide_header Access-Control-Allow-Origin;
        add_header Access-Control-Allow-Origin * always;
        add_header Access-Control-Allow-Methods "GET, POST, OPTIONS" always;
        add_header Access-Control-Allow-Headers "Origin, X-Requested-With, Content-Type, Accept, Authorization" always;

        sub_filter_once off;
        sub_filter_types application/json application/xml text/xml text/plain;
        sub_filter 'https://api.bom.gov.au' 'http://$http_host';
        sub_filter 'https:\/\/api.bom.gov.au' 'http:\/\/$http_host';
        sub_filter 'https://www.bom.gov.au' 'http://$http_host';
        sub_filter 'https:\/\/www.bom.gov.au' 'http:\/\/$http_host';
    }

    # HIGH PRIORITY - BOM API calls (must be first)
    location ~ ^/(apikey|api|v1|mapping|locations|services|places|forecasts|weather)/ {
        limit_req zone=api burst=30 nodelay;
        
        # Perfect API headers
        proxy_set_header Host api.bom.gov.au;
        proxy_set_header User-Agent "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36";
        proxy_set_header Accept "application/json, text/plain, */*";
        proxy_set_header Accept-Language "en-AU,en-GB;q=0.9,en-US;q=0.8,en;q=0.7";
        # Disable upstream compression so sub_filter can rewrite payload URLs.
        proxy_set_header Accept-Encoding "";
        proxy_set_header Content-Type "application/json";
        proxy_set_header Sec-Ch-Ua '"Not_A Brand";v="8", "Chromium";v="120", "Google Chrome";v="120"';
        proxy_set_header Sec-Ch-Ua-Mobile "?0";
        proxy_set_header Sec-Ch-Ua-Platform '"Windows"';
        proxy_set_header Sec-Fetch-Dest "empty";
        proxy_set_header Sec-Fetch-Mode "cors";
        proxy_set_header Sec-Fetch-Site "cross-site";
        proxy_set_header Origin "https://www.bom.gov.au";
        proxy_set_header Referer "https://www.bom.gov.au/location/australia/victoria/central/o2594692629-ashburton";
        
        # Remove proxy traces
        proxy_set_header X-Real-IP "";
        proxy_set_header X-Forwarded-For "";
        proxy_set_header X-Forwarded-Proto "";
        
        proxy_pass https://bom_api$request_uri;
        proxy_ssl_server_name on;
        proxy_ssl_verify off;
        proxy_http_version 1.1;
        
        # API timeouts
        proxy_connect_timeout 30s;
        proxy_send_timeout 30s;
        proxy_read_timeout 30s;
        
        # CORS for API responses
        proxy_hide_header Access-Control-Allow-Origin;
        add_header Access-Control-Allow-Origin * always;
        add_header Access-Control-Allow-Methods "GET, POST, OPTIONS" always;
        add_header Access-Control-Allow-Headers "Origin, X-Requested-With, Content-Type, Accept, Authorization" always;

        # Rewrite API host references embedded in JSON/XML payloads.
        sub_filter_once off;
        sub_filter_types application/json application/xml text/xml text/plain;
        sub_filter 'https://api.bom.gov.au' 'http://$http_host';
        sub_filter 'https:\/\/api.bom.gov.au' 'http:\/\/$http_host';
        sub_filter 'https://www.bom.gov.au' 'http://$http_host';
        sub_filter 'https:\/\/www.bom.gov.au' 'http:\/\/$http_host';
    }

    # Map services can be requested directly by BOM runtime without /apikey/v1/mapping.
    location ~ ^/(timeseries|overlays|basemaps)/ {
        # Tile requests arrive in short bursts; allow queueing instead of 503 drops.
        limit_req zone=api burst=300;

        proxy_set_header Host api.bom.gov.au;
        proxy_set_header User-Agent "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36";
        proxy_set_header Accept "*/*";
        proxy_set_header Accept-Language "en-AU,en-GB;q=0.9,en-US;q=0.8,en;q=0.7";
        proxy_set_header Accept-Encoding "";
        proxy_set_header Sec-Fetch-Dest "empty";
        proxy_set_header Sec-Fetch-Mode "cors";
        proxy_set_header Sec-Fetch-Site "cross-site";
        proxy_set_header Origin "https://www.bom.gov.au";
        proxy_set_header Referer "https://www.bom.gov.au/location/australia/victoria/central/o2594692629-ashburton";

        proxy_set_header X-Real-IP "";
        proxy_set_header X-Forwarded-For "";
        proxy_set_header X-Forwarded-Proto "";

        proxy_pass https://bom_api/apikey/v1/mapping$request_uri;
        proxy_ssl_server_name on;
        proxy_ssl_verify off;
        proxy_http_version 1.1;

        proxy_connect_timeout 30s;
        proxy_send_timeout 30s;
        proxy_read_timeout 60s;

        proxy_cache bom_tiles;
        proxy_cache_methods GET HEAD;
        proxy_cache_lock on;
        proxy_cache_background_update on;
        proxy_cache_revalidate on;
        proxy_ignore_headers Cache-Control Expires Set-Cookie;
        proxy_hide_header Set-Cookie;
        proxy_hide_header Cache-Control;
        proxy_hide_header Expires;
        proxy_cache_valid 200 301 302 60s;
        proxy_cache_valid 404 30s;

        proxy_hide_header Access-Control-Allow-Origin;
        add_header Access-Control-Allow-Origin * always;
        add_header Access-Control-Allow-Methods "GET, POST, OPTIONS" always;
        add_header Access-Control-Allow-Headers "Origin, X-Requested-With, Content-Type, Accept, Authorization" always;
        add_header Cache-Control "public, max-age=60";
        add_header X-Proxy-Cache $upstream_cache_status always;
    }

    # Perfect browser simulation for BOM pages
    location ~ ^/location/ {
        if ($arg_showTownNames ~* "^(1|true|on|yes)$") {
            add_header Set-Cookie "bom_show_town_names=1; Path=/; Max-Age=604800; SameSite=Lax" always;
        }
        if ($arg_showTownNames ~* "^(0|false|off|no)$") {
            add_header Set-Cookie "bom_show_town_names=0; Path=/; Max-Age=604800; SameSite=Lax" always;
        }

        # Rate limiting like human browsing
        limit_req zone=browser burst=5 nodelay;
        
        # PERFECT Chrome 120 headers from real browser
        proxy_set_header Host www.bom.gov.au;
        proxy_set_header User-Agent "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36";
        
        # Exact Accept headers from Chrome
        proxy_set_header Accept "text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.7";
        proxy_set_header Accept-Language "en-AU,en-GB;q=0.9,en-US;q=0.8,en;q=0.7";
        # Disable upstream compression so sub_filter can run on HTML.
        proxy_set_header Accept-Encoding "";
        
        # Chrome security headers
        proxy_set_header Sec-Ch-Ua '"Not_A Brand";v="8", "Chromium";v="120", "Google Chrome";v="120"';
        proxy_set_header Sec-Ch-Ua-Mobile "?0";
        proxy_set_header Sec-Ch-Ua-Platform '"Windows"';
        proxy_set_header Sec-Fetch-Dest "document";
        proxy_set_header Sec-Fetch-Mode "navigate";
        proxy_set_header Sec-Fetch-Site "none";
        proxy_set_header Sec-Fetch-User "?1";
        
        # Browser behavior headers
        proxy_set_header Upgrade-Insecure-Requests "1";
        proxy_set_header DNT "1";
        proxy_set_header Cache-Control "max-age=0";
        
        # Connection headers
        proxy_set_header Connection "keep-alive";
        proxy_http_version 1.1;
        
        # REMOVE all proxy-identifying headers
        proxy_set_header X-Real-IP "";
        proxy_set_header X-Forwarded-For "";
        proxy_set_header X-Forwarded-Proto "";
        proxy_set_header X-Forwarded-Host "";
        proxy_set_header X-Original-URI "";
        
        # SSL settings for HTTPS upstream
        proxy_pass https://www.bom.gov.au$request_uri;
        proxy_ssl_server_name on;
        proxy_ssl_verify off;
        proxy_ssl_protocols TLSv1.2 TLSv1.3;
        
        # Browser-like timeouts
        proxy_connect_timeout 30s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;
        
        # Hide restrictive headers and add permissive ones
        proxy_hide_header X-Frame-Options;
        proxy_hide_header Content-Security-Policy;
        proxy_hide_header Access-Control-Allow-Origin;
        proxy_hide_header Strict-Transport-Security;
        proxy_hide_header Link;
        proxy_hide_header Cache-Control;
        proxy_hide_header Expires;
        
        add_header Access-Control-Allow-Origin * always;
        add_header X-Frame-Options ALLOWALL always;
        add_header Cache-Control "no-store, no-cache, must-revalidate, max-age=0" always;
        # Lean-mode default: allow only same-origin runtime resources for map-only rendering.
        # This blocks third-party telemetry/tag scripts and external beacons.
        add_header Content-Security-Policy "default-src 'self' data: blob:; script-src 'self' 'unsafe-inline' 'unsafe-eval' blob:; style-src 'self' 'unsafe-inline'; img-src 'self' data: blob:; connect-src 'self'; font-src 'self' data:; worker-src 'self' blob:; frame-src 'self' blob:; object-src 'none'; base-uri 'self'; form-action 'self';" always;
        
        # AGGRESSIVE URL rewriting for embedded content + JavaScript injection
        sub_filter_once off;
        sub_filter_types text/css text/javascript application/javascript application/json text/plain;

        # Disable non-essential anti-bot/telemetry scripts before generic host rewrites.
        sub_filter 'src="https://www.bom.gov.au/akam/' 'data-disabled-src="https://www.bom.gov.au/akam/';
        sub_filter "src='https://www.bom.gov.au/akam/" "data-disabled-src='https://www.bom.gov.au/akam/";
        sub_filter 'https://www.bom.gov.au/akam/' 'http://$http_host/blocked-external/akam/';
        sub_filter 'https:\/\/www.bom.gov.au\/akam\/' 'http:\/\/$http_host\/blocked-external\/akam\/';
        sub_filter 'https://apm.analytics.bom.gov.au' 'http://$http_host/blocked-external/apm';
        sub_filter 'https:\/\/apm.analytics.bom.gov.au' 'http:\/\/$http_host\/blocked-external\/apm';
        
        # Rewrite main domain
        sub_filter 'www.bom.gov.au' '$http_host';
        sub_filter 'https://www.bom.gov.au' 'http://$http_host';
        
        # Rewrite API domain - multiple patterns
        sub_filter 'api.bom.gov.au' '$http_host';
        sub_filter 'api.test2.bom.gov.au' '$http_host';
        sub_filter 'https://api.bom.gov.au' 'http://$http_host';
        sub_filter 'https://api.test2.bom.gov.au' 'http://$http_host';
        sub_filter '"https://api.bom.gov.au' '"http://$http_host';
        sub_filter '"https://api.test2.bom.gov.au' '"http://$http_host';
        sub_filter "'https://api.bom.gov.au" "'http://$http_host";
        sub_filter "'https://api.test2.bom.gov.au" "'http://$http_host";
        sub_filter 'apiBaseUrl:"https://api.bom.gov.au' 'apiBaseUrl:"http://$http_host';
        sub_filter 'apiBaseUrl:"https://api.test2.bom.gov.au' 'apiBaseUrl:"http://$http_host';
        sub_filter 'apiUrl:"https://api.bom.gov.au' 'apiUrl:"http://$http_host';
        sub_filter 'apiUrl:"https://api.test2.bom.gov.au' 'apiUrl:"http://$http_host';
        sub_filter 'API_BASE_URL:"https://api.bom.gov.au' 'API_BASE_URL:"http://$http_host';
        sub_filter 'API_BASE_URL:"https://api.test2.bom.gov.au' 'API_BASE_URL:"http://$http_host';
        sub_filter 'baseURL:"https://api.bom.gov.au' 'baseURL:"http://$http_host';
        sub_filter 'baseURL:"https://api.test2.bom.gov.au' 'baseURL:"http://$http_host';
        sub_filter 'host:"api.bom.gov.au' 'host:"$http_host';
        sub_filter 'host:"api.test2.bom.gov.au' 'host:"$http_host';
        sub_filter "host:'api.bom.gov.au" "host:'$http_host";
        sub_filter "host:'api.test2.bom.gov.au" "host:'$http_host";
        
        # AGGRESSIVE JavaScript API patterns - catch ALL variations
        sub_filter 'apiHost:"api.bom.gov.au"' 'apiHost:"$http_host"';
        sub_filter 'apiHost:"api.test2.bom.gov.au"' 'apiHost:"$http_host"';
        sub_filter "apiHost:'api.bom.gov.au'" "apiHost:'$http_host'";
        sub_filter "apiHost:'api.test2.bom.gov.au'" "apiHost:'$http_host'";
        sub_filter 'api_host:"api.bom.gov.au"' 'api_host:"$http_host"';
        sub_filter 'api_host:"api.test2.bom.gov.au"' 'api_host:"$http_host"';
        sub_filter "api_host:'api.bom.gov.au'" "api_host:'$http_host'";
        sub_filter "api_host:'api.test2.bom.gov.au'" "api_host:'$http_host'";
        
        # Catch hardcoded API endpoints
        sub_filter '/apikey/v1/locations/places/details/place/' '/apikey/v1/locations/places/details/place/';
        sub_filter '"https://api.bom.gov.au/apikey' '"http://$http_host/apikey';
        sub_filter '"https://api.test2.bom.gov.au/apikey' '"http://$http_host/apikey';
        sub_filter "'https://api.bom.gov.au/apikey" "'http://$http_host/apikey";
        sub_filter "'https://api.test2.bom.gov.au/apikey" "'http://$http_host/apikey";
        sub_filter '`https://api.bom.gov.au/apikey' '`http://$http_host/apikey';
        sub_filter '`https://api.test2.bom.gov.au/apikey' '`http://$http_host/apikey';
        sub_filter 'https://api.bom.gov.au/apikey' 'http://$http_host/apikey';
        sub_filter 'https://api.test2.bom.gov.au/apikey' 'http://$http_host/apikey';
        sub_filter 'https:\/\/api.bom.gov.au' 'http:\/\/$http_host';
        sub_filter 'https:\/\/api.test2.bom.gov.au' 'http:\/\/$http_host';
        
        # Configuration object patterns
        sub_filter 'endpoint:"https://api.bom.gov.au' 'endpoint:"http://$http_host';
        sub_filter 'endpoint:"https://api.test2.bom.gov.au' 'endpoint:"http://$http_host';
        sub_filter 'url:"https://api.bom.gov.au' 'url:"http://$http_host';
        sub_filter 'url:"https://api.test2.bom.gov.au' 'url:"http://$http_host';
        sub_filter 'baseUrl:"https://api.bom.gov.au' 'baseUrl:"http://$http_host';
        sub_filter 'baseUrl:"https://api.test2.bom.gov.au' 'baseUrl:"http://$http_host';
        sub_filter 'apiEndpoint:"https://api.bom.gov.au' 'apiEndpoint:"http://$http_host';
        sub_filter 'apiEndpoint:"https://api.test2.bom.gov.au' 'apiEndpoint:"http://$http_host';
        sub_filter 'https:\/\/www.bom.gov.au' 'http:\/\/$http_host';

        # Strip non-essential third-party and tag-manager script fetches from BOM HTML.
        sub_filter 'src="https://www.google.com/recaptcha/' 'data-disabled-src="https://www.google.com/recaptcha/';
        sub_filter "src='https://www.google.com/recaptcha/" "data-disabled-src='https://www.google.com/recaptcha/";
        sub_filter 'src="https://www.googletagmanager.com' 'data-disabled-src="https://www.googletagmanager.com';
        sub_filter "src='https://www.googletagmanager.com" "data-disabled-src='https://www.googletagmanager.com";
        sub_filter '<noscript><iframe src="https://www.googletagmanager.com/ns.html' '<noscript><iframe data-disabled-src="http://$http_host/blocked-external/googletagmanager/ns.html';
        sub_filter '<noscript><iframe data-disabled-src="https://www.googletagmanager.com/ns.html' '<noscript><iframe data-disabled-src="http://$http_host/blocked-external/googletagmanager/ns.html';
        sub_filter 'data-disabled-src="https://www.googletagmanager.com' 'data-disabled-src="http://$http_host/blocked-external/googletagmanager';
        sub_filter "data-disabled-src='https://www.googletagmanager.com" "data-disabled-src='http://$http_host/blocked-external/googletagmanager";
        sub_filter 'src="/modules/contrib/google_tag/js/gtag.js' 'data-disabled-src="/modules/contrib/google_tag/js/gtag.js';
        sub_filter "src='/modules/contrib/google_tag/js/gtag.js" "data-disabled-src='/modules/contrib/google_tag/js/gtag.js";
        sub_filter 'src="/modules/contrib/google_tag/js/gtm.js' 'data-disabled-src="/modules/contrib/google_tag/js/gtm.js';
        sub_filter "src='/modules/contrib/google_tag/js/gtm.js" "data-disabled-src='/modules/contrib/google_tag/js/gtm.js";

        # Rewrite residual telemetry/search domains to local blocked sink.
        sub_filter 'https://s.go-mpulse.net/boomerang/' 'http://$http_host/blocked-external/go-mpulse/';
        sub_filter 'https://s2.go-mpulse.net/boomerang/' 'http://$http_host/blocked-external/go-mpulse/';
        sub_filter 'https://www.googletagmanager.com' 'http://$http_host/blocked-external/googletagmanager';
        sub_filter 'https://www.google-analytics.com' 'http://$http_host/blocked-external/google-analytics';
        sub_filter 'https://www.google.com/recaptcha/' 'http://$http_host/blocked-external/recaptcha/';
        sub_filter 'https://www.gstatic.com/recaptcha/' 'http://$http_host/blocked-external/recaptcha/';
        sub_filter 'https://bom-search.funnelback.squiz.cloud' 'http://$http_host/blocked-external/funnelback';
        sub_filter 'https://www.googletagmanager.com/ns.html' 'http://$http_host/blocked-external/googletagmanager/ns.html';
        sub_filter 'https:\/\/www.googletagmanager.com\/ns.html' 'http:\/\/$http_host\/blocked-external\/googletagmanager\/ns.html';
        # Bust stale cached 204 font responses from earlier lean-mode builds.
        sub_filter 'href="/themes/custom/bom_theme/bom-react/dist/Inter-Regular.woff2"' 'href="/themes/custom/bom_theme/bom-react/dist/Inter-Regular.woff2?v=20260302a"';
        sub_filter 'href="/themes/custom/bom_theme/images/icons/safari-pinned-tab.svg"' 'data-disabled-href="/themes/custom/bom_theme/images/icons/safari-pinned-tab.svg"';
        sub_filter 'src="/themes/custom/bom_theme/images/footer_logo.svg"' 'data-disabled-src="/themes/custom/bom_theme/images/footer_logo.svg"';
        sub_filter 'src="/modules/custom/bom_utilities/images/error.svg"' 'data-disabled-src="/modules/custom/bom_utilities/images/error.svg"';
        sub_filter 'GTM-5JKZLP4' 'GTM-BLOCKED';
        
        # Inject local API/telemetry override script immediately after <head>.
        sub_filter '<head>' '<head><script src="/inject-api-override.js"></script>';
    }

    # Stable local ArcGIS widget locale payloads (prevents intermittent upstream 403 on t9n JSON).
    location = /themes/custom/bom_theme/bom-react/dist/assets/esri/widgets/Zoom/t9n/Zoom.json {
        alias /usr/share/nginx/html/esri-t9n/Zoom.json;
        add_header Content-Type application/json always;
        add_header Access-Control-Allow-Origin * always;
        add_header Cache-Control "public, max-age=3600" always;
    }

    location = /themes/custom/bom_theme/bom-react/dist/assets/esri/widgets/ScaleBar/t9n/ScaleBar.json {
        alias /usr/share/nginx/html/esri-t9n/ScaleBar.json;
        add_header Content-Type application/json always;
        add_header Access-Control-Allow-Origin * always;
        add_header Cache-Control "public, max-age=3600" always;
    }

    location = /themes/custom/bom_theme/bom-react/dist/assets/esri/widgets/Home/t9n/Home.json {
        alias /usr/share/nginx/html/esri-t9n/Home.json;
        add_header Content-Type application/json always;
        add_header Access-Control-Allow-Origin * always;
        add_header Cache-Control "public, max-age=3600" always;
    }

    location = /themes/custom/bom_theme/bom-react/dist/assets/esri/widgets/Attribution/t9n/Attribution.json {
        alias /usr/share/nginx/html/esri-t9n/Attribution.json;
        add_header Content-Type application/json always;
        add_header Access-Control-Allow-Origin * always;
        add_header Cache-Control "public, max-age=3600" always;
    }

    location = /themes/custom/bom_theme/bom-react/dist/assets/esri/t9n/common.json {
        alias /usr/share/nginx/html/esri-t9n/common.json;
        add_header Content-Type application/json always;
        add_header Access-Control-Allow-Origin * always;
        add_header Cache-Control "public, max-age=3600" always;
    }

    # ArcGIS i18n fallback: map missing generic t9n JSON requests to *_en.json variants.
    location ~ ^/themes/custom/bom_theme/bom-react/dist/assets/esri/(?:.*/)?t9n/[^/_]+\.json$ {
        limit_req zone=assets burst=100 nodelay;

        rewrite ^(.*/t9n/)([^/_]+)\.json$ $1$2_en.json break;

        proxy_set_header Host www.bom.gov.au;
        proxy_set_header User-Agent "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36";
        proxy_set_header Accept "application/json, text/plain, */*";
        proxy_set_header Accept-Language "en-AU,en-GB;q=0.9,en-US;q=0.8,en;q=0.7";
        proxy_set_header Accept-Encoding "gzip, deflate, br";
        proxy_set_header Sec-Fetch-Dest "empty";
        proxy_set_header Sec-Fetch-Mode "cors";
        proxy_set_header Sec-Fetch-Site "same-origin";
        proxy_set_header Referer "https://www.bom.gov.au/";

        proxy_pass https://www.bom.gov.au$uri;
        proxy_ssl_server_name on;
        proxy_ssl_verify off;

        proxy_hide_header Access-Control-Allow-Origin;
        add_header Access-Control-Allow-Origin * always;
        add_header Cache-Control "public, max-age=3600" always;
    }

    # Static assets with perfect browser headers
    location @proxy_static {
        # API rate limiting
        limit_req zone=api burst=20 nodelay;
        
        proxy_set_header Host www.bom.gov.au;
        proxy_set_header User-Agent "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36";
        proxy_set_header Accept "*/*";
        proxy_set_header Accept-Language "en-AU,en-GB;q=0.9,en-US;q=0.8,en;q=0.7";
        proxy_set_header Accept-Encoding "gzip, deflate, br";
        proxy_set_header Sec-Ch-Ua '"Not_A Brand";v="8", "Chromium";v="120", "Google Chrome";v="120"';
        proxy_set_header Sec-Ch-Ua-Mobile "?0";
        proxy_set_header Sec-Ch-Ua-Platform '"Windows"';
        proxy_set_header Sec-Fetch-Dest "image";
        proxy_set_header Sec-Fetch-Mode "no-cors";
        proxy_set_header Sec-Fetch-Site "same-origin";
        proxy_set_header Referer "https://www.bom.gov.au/";
        
        proxy_pass https://www.bom.gov.au$request_uri;
        proxy_ssl_server_name on;
        proxy_ssl_verify off;
        
        proxy_hide_header Access-Control-Allow-Origin;
        add_header Access-Control-Allow-Origin * always;
        add_header Cache-Control "public, max-age=3600";
    }

    # API endpoints with browser headers
    location ~ ^/(api|ajax|data)/ {
        limit_req zone=api burst=10 nodelay;
        
        proxy_set_header Host www.bom.gov.au;
        proxy_set_header User-Agent "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36";
        proxy_set_header Accept "application/json, text/plain, */*";
        proxy_set_header Accept-Language "en-AU,en-GB;q=0.9,en-US;q=0.8,en;q=0.7";
        proxy_set_header Accept-Encoding "gzip, deflate, br";
        proxy_set_header Content-Type "application/json";
        proxy_set_header Sec-Fetch-Dest "empty";
        proxy_set_header Sec-Fetch-Mode "cors";
        proxy_set_header Sec-Fetch-Site "same-origin";
        proxy_set_header Referer "https://www.bom.gov.au/";
        proxy_set_header Origin "https://www.bom.gov.au";
        
        proxy_pass https://www.bom.gov.au$request_uri;
        proxy_ssl_server_name on;
        proxy_ssl_verify off;
        
        proxy_hide_header Access-Control-Allow-Origin;
        add_header Access-Control-Allow-Origin * always;
    }

    # Static resources (CSS, JS, images) - handle ALL BOM asset paths
    location ~ ^/(themes|sites|core|misc|profiles|modules|libraries|files)/ {
        limit_req zone=assets burst=100 nodelay;
        
        proxy_set_header Host www.bom.gov.au;
        proxy_set_header User-Agent "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36";
        proxy_set_header Accept "*/*";
        proxy_set_header Accept-Language "en-AU,en-GB;q=0.9,en-US;q=0.8,en;q=0.7";
        proxy_set_header Accept-Encoding "gzip, deflate, br";
        proxy_set_header Sec-Ch-Ua '"Not_A Brand";v="8", "Chromium";v="120", "Google Chrome";v="120"';
        proxy_set_header Sec-Ch-Ua-Mobile "?0";
        proxy_set_header Sec-Ch-Ua-Platform '"Windows"';
        proxy_set_header Sec-Fetch-Dest "script";
        proxy_set_header Sec-Fetch-Mode "no-cors";
        proxy_set_header Sec-Fetch-Site "same-origin";
        proxy_set_header Origin "https://www.bom.gov.au";
        proxy_set_header Referer "https://www.bom.gov.au/";
        
        proxy_pass https://www.bom.gov.au$request_uri;
        proxy_ssl_server_name on;
        proxy_ssl_verify off;
        
        proxy_hide_header Access-Control-Allow-Origin;
        add_header Access-Control-Allow-Origin * always;
        
        # Long cache for static assets
        expires 1h;
        add_header Cache-Control "public, max-age=3600";
    }

    # Specific handling for any CSS/JS files that might be missed
    location ~ \.(css|js|woff|woff2|ttf|eot|svg|png|jpg|jpeg|gif|ico)$ {
        limit_req zone=assets burst=200 nodelay;
        
        proxy_set_header Host www.bom.gov.au;
        proxy_set_header User-Agent "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36";
        proxy_set_header Accept "*/*";
        proxy_set_header Accept-Language "en-AU,en-GB;q=0.9,en-US;q=0.8,en;q=0.7";
        proxy_set_header Accept-Encoding "gzip, deflate, br";
        proxy_set_header Sec-Ch-Ua '"Not_A Brand";v="8", "Chromium";v="120", "Google Chrome";v="120"';
        proxy_set_header Sec-Ch-Ua-Mobile "?0";
        proxy_set_header Sec-Ch-Ua-Platform '"Windows"';
        proxy_set_header Sec-Fetch-Dest "style";
        proxy_set_header Sec-Fetch-Mode "no-cors";
        proxy_set_header Sec-Fetch-Site "same-origin";
        proxy_set_header Origin "https://www.bom.gov.au";
        proxy_set_header Referer "https://www.bom.gov.au/";
        
        # Remove proxy identifying headers
        proxy_set_header X-Real-IP "";
        proxy_set_header X-Forwarded-For "";
        proxy_set_header X-Forwarded-Proto "";
        
        proxy_pass https://www.bom.gov.au$request_uri;
        proxy_ssl_server_name on;
        proxy_ssl_verify off;
        
        proxy_hide_header Access-Control-Allow-Origin;
        add_header Access-Control-Allow-Origin * always;
        
        expires 24h;
        add_header Cache-Control "public, max-age=86400";
    }

    # Fallback with perfect browser simulation
    location / {
        limit_req zone=browser burst=3 nodelay;
        
        # Complete Chrome 120 header set
        proxy_set_header Host www.bom.gov.au;
        proxy_set_header User-Agent "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36";
        proxy_set_header Accept "text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.7";
        proxy_set_header Accept-Language "en-AU,en-GB;q=0.9,en-US;q=0.8,en;q=0.7";
        proxy_set_header Accept-Encoding "";
        proxy_set_header Sec-Ch-Ua '"Not_A Brand";v="8", "Chromium";v="120", "Google Chrome";v="120"';
        proxy_set_header Sec-Ch-Ua-Mobile "?0";
        proxy_set_header Sec-Ch-Ua-Platform '"Windows"';
        proxy_set_header Sec-Fetch-Dest "document";
        proxy_set_header Sec-Fetch-Mode "navigate";
        proxy_set_header Sec-Fetch-Site "none";
        proxy_set_header Sec-Fetch-User "?1";
        proxy_set_header Upgrade-Insecure-Requests "1";
        proxy_set_header Connection "keep-alive";
        
        # Remove ALL proxy traces
        proxy_set_header X-Real-IP "";
        proxy_set_header X-Forwarded-For "";
        proxy_set_header X-Forwarded-Proto "";
        proxy_set_header X-Forwarded-Host "";
        proxy_set_header Forwarded "";
        
        proxy_pass https://www.bom.gov.au$request_uri;
        proxy_ssl_server_name on;
        proxy_ssl_verify off;
        proxy_http_version 1.1;
        
        # Browser-like timeouts
        proxy_connect_timeout 30s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;
        
        # Hide ALL restrictive headers
        proxy_hide_header X-Frame-Options;
        proxy_hide_header Content-Security-Policy;
        proxy_hide_header Access-Control-Allow-Origin;
        proxy_hide_header Strict-Transport-Security;
        proxy_hide_header X-XSS-Protection;
        proxy_hide_header X-Content-Type-Options;
        proxy_hide_header Referrer-Policy;
        
        # Add permissive headers
        add_header Access-Control-Allow-Origin * always;
        add_header X-Frame-Options ALLOWALL always;
        
        # Comprehensive URL rewriting
        sub_filter_once off;
        sub_filter_types text/css text/javascript application/javascript application/json;
        
        # Rewrite main domain
        sub_filter 'www.bom.gov.au' '$http_host';
        sub_filter 'https://www.bom.gov.au' 'http://$http_host';
        
        # Rewrite API domain - comprehensive patterns  
        sub_filter 'api.bom.gov.au' '$http_host';
        sub_filter 'https://api.bom.gov.au' 'http://$http_host';
        
        # Block Akamai tracking/analytics calls
        sub_filter 'https://www.bom.gov.au/akam/' 'http://$http_host/blocked-external/akam/';
        sub_filter '"https://api.bom.gov.au' '"http://$http_host';
        sub_filter "'https://api.bom.gov.au" "'http://$http_host";
        sub_filter 'apiBaseUrl:"https://api.bom.gov.au' 'apiBaseUrl:"http://$http_host';
        sub_filter 'API_BASE_URL:"https://api.bom.gov.au' 'API_BASE_URL:"http://$http_host';
        sub_filter 'baseURL:"https://api.bom.gov.au' 'baseURL:"http://$http_host';
        sub_filter 'https:\/\/api.bom.gov.au' 'http:\/\/$http_host';
        sub_filter 'https:\/\/www.bom.gov.au' 'http:\/\/$http_host';
        
        # Tiny delay to mimic browser processing
    }
}
