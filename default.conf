# BOM Interactive Proxy Configuration

# Upstream BOM servers
upstream bom_main {
    server www.bom.gov.au:443;
    keepalive 32;
}

# Cache settings
proxy_cache_path /tmp/nginx_cache levels=1:2 keys_zone=bom_cache:10m max_size=100m inactive=60m use_temp_path=off;

server {
    listen 80;
    server_name _;
    
    # CORS headers for Home Assistant integration
    add_header Access-Control-Allow-Origin * always;
    add_header Access-Control-Allow-Methods "GET, POST, OPTIONS" always;
    add_header Access-Control-Allow-Headers "Origin, X-Requested-With, Content-Type, Accept, Authorization" always;
    add_header X-Frame-Options ALLOWALL always;
    
    # Handle preflight requests
    if ($request_method = 'OPTIONS') {
        add_header Access-Control-Allow-Origin * always;
        add_header Access-Control-Allow-Methods "GET, POST, OPTIONS" always;
        add_header Access-Control-Allow-Headers "Origin, X-Requested-With, Content-Type, Accept, Authorization" always;
        return 204;
    }

    # Health check endpoint
    location /health {
        access_log off;
        return 200 "OK\n";
        add_header Content-Type text/plain;
    }

    # Custom map page for Home Assistant
    location /map {
        alias /usr/share/nginx/html/;
        index map.html;
        try_files $uri $uri/ =404;
    }

    # Proxy BOM location pages (the interactive maps)
    location ~ ^/location/(.*)$ {
        proxy_pass https://bom_main/location/$1;
        proxy_ssl_server_name on;
        proxy_ssl_verify off;
        proxy_set_header Host www.bom.gov.au;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header User-Agent "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36";
        
        # Cache for performance
        proxy_cache bom_cache;
        proxy_cache_valid 200 5m;
        proxy_cache_key "$scheme$request_method$host$request_uri";
        
        # Rewrite response to fix URLs and add CORS
        sub_filter_once off;
        sub_filter_types text/html text/css text/javascript application/javascript;
        sub_filter 'www.bom.gov.au' '$host';
        sub_filter 'https://www.bom.gov.au' 'http://$host';
        sub_filter '/themes/' '/themes/';
        sub_filter '/sites/' '/sites/';
    }

    # Proxy BOM static assets (CSS, JS, images)
    location ~ ^/(themes|sites|core|misc)/ {
        proxy_pass https://bom_main$request_uri;
        proxy_ssl_server_name on;
        proxy_ssl_verify off;
        proxy_set_header Host www.bom.gov.au;
        proxy_set_header User-Agent "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36";
        
        # Cache static assets longer
        proxy_cache bom_cache;
        proxy_cache_valid 200 1h;
        proxy_cache_key "$scheme$request_method$host$request_uri";
        
        # Add appropriate headers
        expires 1h;
    }

    # Proxy BOM API endpoints
    location ~ ^/(api|ajax|data)/ {
        proxy_pass https://bom_main$request_uri;
        proxy_ssl_server_name on;
        proxy_ssl_verify off;
        proxy_set_header Host www.bom.gov.au;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header User-Agent "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36";
        
        # Shorter cache for API data
        proxy_cache bom_cache;
        proxy_cache_valid 200 1m;
    }

    # Fallback - proxy everything else to BOM
    location / {
        proxy_pass https://bom_main$request_uri;
        proxy_ssl_server_name on;
        proxy_ssl_verify off;
        proxy_set_header Host www.bom.gov.au;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header User-Agent "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36";
        
        # URL rewriting in response
        sub_filter_once off;
        sub_filter_types text/html text/css text/javascript application/javascript;
        sub_filter 'www.bom.gov.au' '$host';
        sub_filter 'https://www.bom.gov.au' 'http://$host';
    }
}