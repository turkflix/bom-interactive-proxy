# BOM Interactive Proxy - Enhanced Browser Simulation

server {
    listen 80;
    server_name _;
    
    # DNS resolver for Docker containers
    resolver 8.8.8.8 1.1.1.1 valid=300s;
    resolver_timeout 5s;

    # Health check endpoint
    location = /health {
        access_log off;
        add_header Content-Type text/plain always;
        add_header Access-Control-Allow-Origin * always;
        add_header Access-Control-Allow-Methods "GET, POST, OPTIONS" always;
        add_header Access-Control-Allow-Headers "Origin, X-Requested-With, Content-Type, Accept, Authorization" always;
        add_header X-Frame-Options ALLOWALL always;
        return 200 "OK\n";
    }

    # Custom map page
    location = /map {
        alias /usr/share/nginx/html/;
        index map.html;
        try_files /map.html =404;
        add_header Access-Control-Allow-Origin * always;
        add_header X-Frame-Options ALLOWALL always;
    }
    
    # Test pages
    location ~ ^/(iframe-test|test-page)\.html$ {
        alias /usr/share/nginx/html/;
        try_files $uri =404;
        add_header Access-Control-Allow-Origin * always;
        add_header X-Frame-Options ALLOWALL always;
    }

    # BOM location pages proxy with enhanced browser simulation
    location ~ ^/location/ {
        # Enhanced browser headers
        proxy_set_header Host www.bom.gov.au;
        proxy_set_header User-Agent "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36";
        proxy_set_header Accept "text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8";
        proxy_set_header Accept-Language "en-AU,en-US;q=0.9,en;q=0.8";
        proxy_set_header Accept-Encoding "gzip, deflate, br";
        proxy_set_header DNT "1";
        proxy_set_header Upgrade-Insecure-Requests "1";
        proxy_set_header Sec-Fetch-Dest "document";
        proxy_set_header Sec-Fetch-Mode "navigate";
        proxy_set_header Sec-Fetch-Site "none";
        proxy_set_header Sec-Fetch-User "?1";
        proxy_set_header Cache-Control "max-age=0";
        
        # Remove original headers that might identify proxy
        proxy_set_header X-Real-IP "";
        proxy_set_header X-Forwarded-For "";
        proxy_set_header X-Forwarded-Proto "";
        
        proxy_pass https://www.bom.gov.au$request_uri;
        proxy_ssl_server_name on;
        proxy_ssl_verify off;
        
        # Hide BOM's restrictive headers
        proxy_hide_header X-Frame-Options;
        proxy_hide_header Content-Security-Policy;
        proxy_hide_header Access-Control-Allow-Origin;
        
        # Add our permissive headers
        add_header Access-Control-Allow-Origin * always;
        add_header X-Frame-Options ALLOWALL always;
        
        # URL rewriting for embedded resources
        sub_filter_once off;
        sub_filter_types text/html text/css text/javascript application/javascript;
        sub_filter 'www.bom.gov.au' '$host';
        sub_filter 'https://www.bom.gov.au' 'http://$host';
    }

    # BOM static assets with browser headers
    location ~ ^/(themes|sites|core|misc|profiles)/ {
        proxy_set_header Host www.bom.gov.au;
        proxy_set_header User-Agent "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36";
        proxy_set_header Accept "*/*";
        proxy_set_header Accept-Language "en-AU,en-US;q=0.9,en;q=0.8";
        proxy_set_header Referer "https://www.bom.gov.au/";
        
        proxy_pass https://www.bom.gov.au$request_uri;
        proxy_ssl_server_name on;
        proxy_ssl_verify off;
        
        proxy_hide_header Access-Control-Allow-Origin;
        add_header Access-Control-Allow-Origin * always;
        expires 1h;
    }

    # API endpoints
    location ~ ^/(api|ajax|data)/ {
        proxy_set_header Host www.bom.gov.au;
        proxy_set_header User-Agent "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36";
        proxy_set_header Accept "application/json, text/plain, */*";
        proxy_set_header Accept-Language "en-AU,en-US;q=0.9,en;q=0.8";
        proxy_set_header Referer "https://www.bom.gov.au/";
        
        proxy_pass https://www.bom.gov.au$request_uri;
        proxy_ssl_server_name on;
        proxy_ssl_verify off;
        
        proxy_hide_header Access-Control-Allow-Origin;
        add_header Access-Control-Allow-Origin * always;
    }

    # Fallback - proxy everything else with full browser simulation
    location / {
        proxy_set_header Host www.bom.gov.au;
        proxy_set_header User-Agent "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36";
        proxy_set_header Accept "text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8";
        proxy_set_header Accept-Language "en-AU,en-US;q=0.9,en;q=0.8";
        proxy_set_header Accept-Encoding "gzip, deflate, br";
        proxy_set_header Referer "https://www.bom.gov.au/";
        
        proxy_pass https://www.bom.gov.au$request_uri;
        proxy_ssl_server_name on;
        proxy_ssl_verify off;
        
        proxy_hide_header X-Frame-Options;
        proxy_hide_header Access-Control-Allow-Origin;
        add_header Access-Control-Allow-Origin * always;
        add_header X-Frame-Options ALLOWALL always;
        
        # URL rewriting
        sub_filter_once off;
        sub_filter_types text/html text/css text/javascript application/javascript;
        sub_filter 'www.bom.gov.au' '$host';
        sub_filter 'https://www.bom.gov.au' 'http://$host';
    }
}