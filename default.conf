# BOM Interactive Proxy - Perfect Browser Simulation

# Rate limiting to mimic human browsing patterns  
limit_req_zone $binary_remote_addr zone=browser:10m rate=20r/s;
limit_req_zone $binary_remote_addr zone=api:10m rate=100r/s;
limit_req_zone $binary_remote_addr zone=assets:10m rate=200r/s;

server {
    listen 80;
    server_name _;
    
    # DNS resolver 
    resolver 8.8.8.8 1.1.1.1 valid=300s;
    resolver_timeout 5s;
    
    # Browser-like connection settings
    keepalive_timeout 65;
    keepalive_requests 1000;
    
    # Add realistic delays to mimic browser loading
    location ~ \.(css|js|png|jpg|jpeg|gif|ico|svg)$ {
        access_log off;
        add_header Cache-Control "public, max-age=31536000, immutable";
        try_files $uri @proxy_static;
    }

    # Health check endpoint
    location = /health {
        access_log off;
        add_header Content-Type text/plain always;
        add_header Access-Control-Allow-Origin * always;
        return 200 "OK\n";
    }

    # Custom map page
    location = /map {
        alias /usr/share/nginx/html/;
        index map.html;
        try_files /map.html =404;
        add_header Access-Control-Allow-Origin * always;
        add_header X-Frame-Options ALLOWALL always;
    }

    # Perfect browser simulation for BOM pages
    location ~ ^/location/ {
        # Rate limiting like human browsing
        limit_req zone=browser burst=5 nodelay;
        
        # PERFECT Chrome 120 headers from real browser
        proxy_set_header Host www.bom.gov.au;
        proxy_set_header User-Agent "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36";
        
        # Exact Accept headers from Chrome
        proxy_set_header Accept "text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.7";
        proxy_set_header Accept-Language "en-AU,en-GB;q=0.9,en-US;q=0.8,en;q=0.7";
        proxy_set_header Accept-Encoding "gzip, deflate, br";
        
        # Chrome security headers
        proxy_set_header Sec-Ch-Ua '"Not_A Brand";v="8", "Chromium";v="120", "Google Chrome";v="120"';
        proxy_set_header Sec-Ch-Ua-Mobile "?0";
        proxy_set_header Sec-Ch-Ua-Platform '"Windows"';
        proxy_set_header Sec-Fetch-Dest "document";
        proxy_set_header Sec-Fetch-Mode "navigate";
        proxy_set_header Sec-Fetch-Site "none";
        proxy_set_header Sec-Fetch-User "?1";
        
        # Browser behavior headers
        proxy_set_header Upgrade-Insecure-Requests "1";
        proxy_set_header DNT "1";
        proxy_set_header Cache-Control "max-age=0";
        
        # Connection headers
        proxy_set_header Connection "keep-alive";
        proxy_http_version 1.1;
        
        # REMOVE all proxy-identifying headers
        proxy_set_header X-Real-IP "";
        proxy_set_header X-Forwarded-For "";
        proxy_set_header X-Forwarded-Proto "";
        proxy_set_header X-Forwarded-Host "";
        proxy_set_header X-Original-URI "";
        
        # SSL settings for HTTPS upstream
        proxy_pass https://www.bom.gov.au$request_uri;
        proxy_ssl_server_name on;
        proxy_ssl_verify off;
        proxy_ssl_protocols TLSv1.2 TLSv1.3;
        
        # Browser-like timeouts
        proxy_connect_timeout 30s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;
        
        # Hide restrictive headers and add permissive ones
        proxy_hide_header X-Frame-Options;
        proxy_hide_header Content-Security-Policy;
        proxy_hide_header Access-Control-Allow-Origin;
        proxy_hide_header Strict-Transport-Security;
        
        add_header Access-Control-Allow-Origin * always;
        add_header X-Frame-Options ALLOWALL always;
        
        # URL rewriting for embedded content
        sub_filter_once off;
        sub_filter_types text/html text/css text/javascript application/javascript;
        sub_filter 'www.bom.gov.au' '$host';
        sub_filter 'https://www.bom.gov.au' 'http://$host';
        
        # Add small delay to mimic browser rendering
    }

    # Static assets with perfect browser headers
    location @proxy_static {
        # API rate limiting
        limit_req zone=api burst=20 nodelay;
        
        proxy_set_header Host www.bom.gov.au;
        proxy_set_header User-Agent "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36";
        proxy_set_header Accept "image/avif,image/webp,image/apng,image/svg+xml,image/*,*/*;q=0.8";
        proxy_set_header Accept-Language "en-AU,en-GB;q=0.9,en-US;q=0.8,en;q=0.7";
        proxy_set_header Accept-Encoding "gzip, deflate, br";
        proxy_set_header Sec-Fetch-Dest "image";
        proxy_set_header Sec-Fetch-Mode "no-cors";
        proxy_set_header Sec-Fetch-Site "same-origin";
        proxy_set_header Referer "https://www.bom.gov.au/";
        
        proxy_pass https://www.bom.gov.au$request_uri;
        proxy_ssl_server_name on;
        proxy_ssl_verify off;
        
        proxy_hide_header Access-Control-Allow-Origin;
        add_header Access-Control-Allow-Origin * always;
        add_header Cache-Control "public, max-age=3600";
    }

    # API endpoints with browser headers
    location ~ ^/(api|ajax|data)/ {
        limit_req zone=api burst=10 nodelay;
        
        proxy_set_header Host www.bom.gov.au;
        proxy_set_header User-Agent "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36";
        proxy_set_header Accept "application/json, text/plain, */*";
        proxy_set_header Accept-Language "en-AU,en-GB;q=0.9,en-US;q=0.8,en;q=0.7";
        proxy_set_header Accept-Encoding "gzip, deflate, br";
        proxy_set_header Content-Type "application/json";
        proxy_set_header Sec-Fetch-Dest "empty";
        proxy_set_header Sec-Fetch-Mode "cors";
        proxy_set_header Sec-Fetch-Site "same-origin";
        proxy_set_header Referer "https://www.bom.gov.au/";
        proxy_set_header Origin "https://www.bom.gov.au";
        
        proxy_pass https://www.bom.gov.au$request_uri;
        proxy_ssl_server_name on;
        proxy_ssl_verify off;
        
        proxy_hide_header Access-Control-Allow-Origin;
        add_header Access-Control-Allow-Origin * always;
    }

    # Static resources (CSS, JS, images) - handle ALL BOM asset paths
    location ~ ^/(themes|sites|core|misc|profiles|modules|libraries|files)/ {
        limit_req zone=assets burst=100 nodelay;
        
        proxy_set_header Host www.bom.gov.au;
        proxy_set_header User-Agent "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36";
        proxy_set_header Accept "*/*";
        proxy_set_header Accept-Language "en-AU,en-GB;q=0.9,en-US;q=0.8,en;q=0.7";
        proxy_set_header Accept-Encoding "gzip, deflate, br";
        proxy_set_header Sec-Ch-Ua '"Not_A Brand";v="8", "Chromium";v="120", "Google Chrome";v="120"';
        proxy_set_header Sec-Ch-Ua-Mobile "?0";
        proxy_set_header Sec-Ch-Ua-Platform '"Windows"';
        proxy_set_header Sec-Fetch-Dest "script";
        proxy_set_header Sec-Fetch-Mode "no-cors";
        proxy_set_header Sec-Fetch-Site "same-origin";
        proxy_set_header Origin "https://www.bom.gov.au";
        proxy_set_header Referer "https://www.bom.gov.au/";
        
        proxy_pass https://www.bom.gov.au$request_uri;
        proxy_ssl_server_name on;
        proxy_ssl_verify off;
        
        proxy_hide_header Access-Control-Allow-Origin;
        add_header Access-Control-Allow-Origin * always;
        
        # Long cache for static assets
        expires 1h;
        add_header Cache-Control "public, max-age=3600";
    }

    # Specific handling for any CSS/JS files that might be missed
    location ~ \.(css|js|woff|woff2|ttf|eot|svg|png|jpg|jpeg|gif|ico)$ {
        limit_req zone=assets burst=200 nodelay;
        
        proxy_set_header Host www.bom.gov.au;
        proxy_set_header User-Agent "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36";
        proxy_set_header Accept "*/*";
        proxy_set_header Accept-Language "en-AU,en-GB;q=0.9,en-US;q=0.8,en;q=0.7";
        proxy_set_header Accept-Encoding "gzip, deflate, br";
        proxy_set_header Sec-Ch-Ua '"Not_A Brand";v="8", "Chromium";v="120", "Google Chrome";v="120"';
        proxy_set_header Sec-Ch-Ua-Mobile "?0";
        proxy_set_header Sec-Ch-Ua-Platform '"Windows"';
        proxy_set_header Sec-Fetch-Dest "style";
        proxy_set_header Sec-Fetch-Mode "no-cors";
        proxy_set_header Sec-Fetch-Site "same-origin";
        proxy_set_header Origin "https://www.bom.gov.au";
        proxy_set_header Referer "https://www.bom.gov.au/";
        
        # Remove proxy identifying headers
        proxy_set_header X-Real-IP "";
        proxy_set_header X-Forwarded-For "";
        proxy_set_header X-Forwarded-Proto "";
        
        proxy_pass https://www.bom.gov.au$request_uri;
        proxy_ssl_server_name on;
        proxy_ssl_verify off;
        
        proxy_hide_header Access-Control-Allow-Origin;
        add_header Access-Control-Allow-Origin * always;
        
        expires 24h;
        add_header Cache-Control "public, max-age=86400";
    }

    # Fallback with perfect browser simulation
    location / {
        limit_req zone=browser burst=3 nodelay;
        
        # Complete Chrome 120 header set
        proxy_set_header Host www.bom.gov.au;
        proxy_set_header User-Agent "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36";
        proxy_set_header Accept "text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.7";
        proxy_set_header Accept-Language "en-AU,en-GB;q=0.9,en-US;q=0.8,en;q=0.7";
        proxy_set_header Accept-Encoding "gzip, deflate, br";
        proxy_set_header Sec-Ch-Ua '"Not_A Brand";v="8", "Chromium";v="120", "Google Chrome";v="120"';
        proxy_set_header Sec-Ch-Ua-Mobile "?0";
        proxy_set_header Sec-Ch-Ua-Platform '"Windows"';
        proxy_set_header Sec-Fetch-Dest "document";
        proxy_set_header Sec-Fetch-Mode "navigate";
        proxy_set_header Sec-Fetch-Site "none";
        proxy_set_header Sec-Fetch-User "?1";
        proxy_set_header Upgrade-Insecure-Requests "1";
        proxy_set_header Connection "keep-alive";
        
        # Remove ALL proxy traces
        proxy_set_header X-Real-IP "";
        proxy_set_header X-Forwarded-For "";
        proxy_set_header X-Forwarded-Proto "";
        proxy_set_header X-Forwarded-Host "";
        proxy_set_header Forwarded "";
        
        proxy_pass https://www.bom.gov.au$request_uri;
        proxy_ssl_server_name on;
        proxy_ssl_verify off;
        proxy_http_version 1.1;
        
        # Browser-like timeouts
        proxy_connect_timeout 30s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;
        
        # Hide ALL restrictive headers
        proxy_hide_header X-Frame-Options;
        proxy_hide_header Content-Security-Policy;
        proxy_hide_header Access-Control-Allow-Origin;
        proxy_hide_header Strict-Transport-Security;
        proxy_hide_header X-XSS-Protection;
        proxy_hide_header X-Content-Type-Options;
        proxy_hide_header Referrer-Policy;
        
        # Add permissive headers
        add_header Access-Control-Allow-Origin * always;
        add_header X-Frame-Options ALLOWALL always;
        
        # URL rewriting
        sub_filter_once off;
        sub_filter_types text/html text/css text/javascript application/javascript;
        sub_filter 'www.bom.gov.au' '$host';
        sub_filter 'https://www.bom.gov.au' 'http://$host';
        
        # Tiny delay to mimic browser processing
    }
}